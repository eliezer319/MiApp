<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Consulta de Asistencia</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Consulta de Asistencia</h1>

  <label>Año:</label>
  <input type="text" id="year" placeholder="Ej: 2025"><br>

  <label>Mes:</label>
  <input type="text" id="month" placeholder="Ej: MARZO"><br>

  <label>Estudiante:</label>
  <input type="text" id="student" placeholder="Ej: Erick Atencio"><br>

  <label>Grupo:</label>
  <input type="text" id="group" placeholder="Ej: X°A"><br><br>

  <button onclick="searchData()">Buscar</button>

  <h2>Resultado:</h2>
  <div id="result">Cargando datos, por favor espera...</div>

  <script>
    let excelData = [];

    // URL raw de tu archivo Excel en GitHub
    const excelUrl = "https://raw.githubusercontent.com/eliezer319/MiApp/main/Datos.xlsx";

    // Función para cargar y parsear el Excel
    async function loadExcel() {
      try {
        const res = await fetch(excelUrl);
        if (!res.ok) throw new Error("No se pudo cargar el archivo Excel.");
        const arrayBuffer = await res.arrayBuffer();
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, { type: "array" });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        excelData = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });
        document.getElementById("result").innerHTML = "Datos cargados. Ingresa los filtros y presiona Buscar.";
      } catch (error) {
        document.getElementById("result").innerHTML = "Error cargando datos: " + error.message;
      }
    }

    loadExcel();

    function searchData() {
      const year = document.getElementById("year").value.trim().toLowerCase();
      const month = document.getElementById("month").value.trim().toLowerCase();
      const student = document.getElementById("student").value.trim().toLowerCase();
      const group = document.getElementById("group").value.trim().toLowerCase();

      const resultDiv = document.getElementById("result");

      if (excelData.length === 0) {
        alert("Los datos aún no están cargados. Intenta de nuevo en unos segundos.");
        return;
      }

      const match = excelData.find(row =>
        String(row["AÑOS"]).trim().toLowerCase() === year &&
        String(row["MESES"]).trim().toLowerCase() === month &&
        String(row["ESTUDIANTE"]).trim().toLowerCase() === student &&
        String(row["GRUPO"]).trim().toLowerCase() === group
      );

      if (match) {
        let html = "<table border='1' cellpadding='5' cellspacing='0'><tr>";

        // Mostrar solo las columnas que no sean "31" (evitar columna extra vacía)
        const keys = Object.keys(match).filter(k => k !== "31");

        // Encabezados
        keys.forEach(key => {
          html += `<th>${key}</th>`;
        });
        html += "</tr><tr>";

        // Valores procesados para asistencia
        keys.forEach(key => {
          let val = match[key];

          // Procesar los días (1 a 30)
          if (!isNaN(parseInt(key)) && parseInt(key) >= 1 && parseInt(key) <= 30) {
            const v = String(val).toLowerCase();
            if (v === "verdadero" || v === "true") val = "✔️";
            else if (v === "falso" || v === "false") val = "";
            else if (v === "a") val = "A";    // Ausencia
            else if (v === "t") val = "T";    // Tardanza
            else if (v === "e") val = "E";    // Excusa
          }

          html += `<td>${val}</td>`;
        });

        html += "</tr></table>";
        resultDiv.innerHTML = html;
      } else {
        resultDiv.innerHTML = "<p>No se encontró ningún registro con esos datos.</p>";
      }
    }
  </script>
</body>
</html>

